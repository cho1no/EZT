<!doctype html>
<html xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<title>회원가입</title>
<meta charset="utf-8">
<style>
form span.error {
	color: red;
	font-size: 10pt;
}

form span {
	color: blue;
	font-size: 10pt;
}
.site-section {
    padding-top: 3rem;
}
</style>
</head>
<body id="top">
		<section class="site-section">
			<div class="container">
				<div class="row">
					<div class="col-lg-6 mb-5" style="margin: auto">
						<h2 class="mb-4">작업자 회원가입</h2>[[${errors}]]
						<!-- 회원가입 폼 -->
						<form th:action="@{/signUp/joinWorker}" th:object="${userVO}" method="post" enctype="multipart/form-data"
							class="p-4 border rounded" name="joinEzt">
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<label class="text-black" for="usersId">아이디</label> 
									<div class="row">
										<div class="col-8">
										<input name="usersId" type="text" id="usersId" th:field="*{usersId}"
											class="form-control" placeholder="아이디를 입력해주세요">
										</div>
										<div class="col-4">
										<button type="button" id="checkBtn"
										class="btn btn-primary float-end text-white ">중복확인</button>
										<input type="hidden" name="checked_id" value="">
										</div>
									</div>
									<span id="erMsg"></span>
								</div>

								<span th:errors="*{usersId}" class="error"></span>
							</div>
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<label class="text-black" for="usersPw">비밀번호</label> <input
										name="usersPw" type="password" id="usersPw"
										th:field="*{usersPw}" class="form-control"
										placeholder="비밀번호를 입력해주세요"> <span class="error"
										th:errors="*{usersPw}"></span>
								</div>
							</div>
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<label class="text-black" for="usersPw">비밀번호확인</label> <input
										name="usersPwCheck" type="password" id="usersPwCheck"
										th:field="*{usersPwCheck}" class="form-control"
										placeholder="비밀번호 확인"> <span class="error"
										th:errors="*{usersPwCheck}"></span>
								</div>
							</div>
							<div class="row form-group">
								<div class="col-md-6 mb-3 mb-md-0">
									<label class="text-black" for="usersName">성명</label>
									 <input name="usersName" type="text" id="usersName"
										th:field="*{usersName}" class="form-control" placeholder="홍길동">
									<span th:errors="*{usersName}" class="error"></span>
								</div>
								<div class="col-md-6 mb-3 mb-md-0" >
									<label class="text-block" for="issuDate">주민등록증 발급일자</label>
									<input type="text" id="issuDate" name="issuDate" class="form-control" placeholder="19001108" maxlength="8">
								</div>
							</div>
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<div>
									<label class="text-black" for="usersRnn">주민등록번호</label>
									</div> 
									<input type="text" id="JUMIN1" maxlength="6" class="form-control col-md-4 d-inline-flex"
										name="usersBirth" placeholder="880101" th:field="*{usersBirth}">
									<label class="d-inline-flex">-</label>
									<input  type="password" id="JUMIN2" maxlength="7" class="form-control col-md-4 d-inline-flex"
										name="usersRnn" placeholder="1234567" th:field="*{usersRnn}"><span></span>
									<input type="button" style="float: right" id="rnnChkBtn" value="실명인증"
										class="btn  btn-primary text-white" > <!-- disabled -->
										
										<input type="hidden" name="checked_jumin" value="">
										<button class="btn btn-primary" style="float: right; display:none;" id="loadChk" type="button">
										  <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
										  <span role="status">검증 중...</span>
										</button>
								</div>
								<span id=juminChk></span>
								<div>
								<input type="text" name="usersGender" id="usersGender" style="display:none;"> 
								</div>
							</div>
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<label class="text-black" for="usersPhone">전화번호</label> <input
										name="usersPhone" type="text" id="usersPhone"
										th:field="*{usersPhone}" class="form-control"
										placeholder="-제외 숫자만 입력해주세요" maxlength="11"><span></span> <span
										th:errors="*{usersPhone}" class="error"></span>
								</div>
							</div>
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<label class="text-black" for="usersNick">닉네임</label> <input
										name="usersNick" type="text" id="usersNick"
										th:field="*{usersNick}" class="form-control"
										placeholder="닉네임을 입력해주세요"> <span></span> <span
										th:errors="*{usersNick}" class="error"></span>
								</div>
							</div>
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<label class="text-black" for="usersEmail">이메일</label> <input
										name="usersEmail" type="text" id="usersEmail"
										th:field="*{usersEmail}" class="form-control"
										placeholder="example@google.com"><span></span> <span
										th:errors="*{usersEmail}" class="error"></span>
								</div>
							</div>
							<div class="row form-group">
								
								<section class="site-section" id="accordion" style="padding: 0">
									<div class="container">
										<div class="row accordion justify-content-center block__76208">
											<div class="col">
												<div class="accordion-item">
													<h6 class="mb-0 heading ms-1">
														<a class="btn-block" data-bs-toggle="collapse"
															href="#collapseFive" role="button" aria-expanded="false"
															aria-controls="collapseFive">국가기술 자격증<span
															class="icon"></span>
														</a>
													</h6>
													<div id="collapseFive" class="collapse"
														aria-labelledby="headingOne" data-parent="#accordion">
														<div class="body-text unity">
														
																<div class="row mb-2">
																	<div class="col-md-4">
																		<label class="text-black" for="lName">자격증 이름</label>
																	</div>
																	<div class="col-md-7">
																		<input type="text" id="lName" class="form-control" th:field="${lcs.licenseInfo}">
																	</div>
																</div>
																<div class="row mb-2">
																	<div class="col-md-4">
																		<label class="text-black" for="lNo">자격증 번호</label>
																	</div>
																	<div class="col-md-7">
																		<input type="text" id="lNo" class="form-control" th:field="${lcs.licenseDetailNo}" maxlength="12">
																	</div>
																</div>
																<div class="row mb-2">
																	<div class="col-md-4">
																		<label class="text-black" for="getDt">취득 일자</label>
																	</div>
																	<div class="col-md-7">
																		<input type="date" id="getDt" class="form-control" th:field="${lcs.licenseGetDt}" >
																	</div>
																</div>
																<div class="row mb-2">
																	<div class="col-md-4">
																		<label class="text-black" for="lChkCenter">발급 기관</label>
																	</div>
																	<div class="col-md-7">
																		<input type="text" id="lChkCenter" class="form-control" th:field="${lcs.checkCenter}" >
																	</div>
																</div>
																<div class="row mb-2">
																	<div class="col-md-4">  
																	<label for="uploadFile" class="text-black">파일첨부</label>
																	</div>
																	<div class="col-md-7"> 
																	<input name="uploadFile" type="file" id="uploadFile" class="form-control">
																	</div>	
																	<span id=licenseChk></span>	
																</div>
																
																<div class="row col-md-12" align="right">
																	<button type="button" id="check-license-Btn" class="btn btn-primary text-white" >검증하기</button><!-- disabled -->
																<input type="hidden" name="checked_license" value="">
																	<button class="btn btn-primary" style="float: right; display:none;" id="licChk" type="button">
																	  <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
																	  <span role="status">검증 중...</span>
																</button>
																</div>
														</div>
													</div>
												</div>
												<!-- .accordion-item -->
											</div>
										</div>
									</div>
								</section>
										
							</div>
							<div class="row form-group">
									<label class="text-black" for="regions">주 활동지역</label>
								<div class="col-md-12 mb-3 mb-md-0">
									<th:block th:each="region : ${regions}">
										<input type="checkbox" th:id="${region.codeNo}" name="regionCode" th:value="${region.codeNo}">
										<label th:for="${region.codeNo}">[[${region.codeName}]]</label>
									</th:block>
								</div>
							</div>
							<div class="row form-group">
									 <label class="text-black" for="categories">작업 분야</label>
								<div class="col-md-12 mb-3 mb-md-0">
										<th:block th:each="category : ${categories}">
											<input type="checkbox" th:id="${category.codeNo}" name="categoryCode" th:value="${category.codeNo}">
											<label th:for="${category.codeNo}">[[${category.codeName}]]</label>
										</th:block>
								</div>
							</div>
							
							<div class="row form-group">
								<div class="col-md-12">
									<input type="button" id="joinBtn" value="가입하기"
										class="btn px-4 btn-primary text-white" style="float: right">
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</section>
</body>
<script th:inline="javascript">
	$('.page-title').text('회원가입');
	$('.page-desc').text('작업자');
	
	//주민등록증 진위여부
		$('#rnnChkBtn').click(() => {checkRnn()});
		function checkRnn(){
			var userName = $('#usersName').val();
			var jumin1 = $('#JUMIN1').val();
			var jumin2 = $('#JUMIN2').val();
			var rnn = jumin1 + jumin2; 
			var issuDate = $('#issuDate').val();
			//console.log(userName, rnn, issuDate);
			if(userName == ''){
				$('#juminChk').text('성명을 입력해주세요.');
				$('#juminChk').addClass('error');
				return false;
			}
			var reqExpUsrNm = /^[가-힣]*$/;
			if(!reqExpUsrNm.test(userName)){
				$('#juminChk').text('성명은 한글로 올바르게 입력해주세요.');
				$('#juminChk').addClass('error');
				return false;
			}
			if(issuDate == ''){
				$('#juminChk').text('주민등록증 발급일자를 입력해주세요.');
				$('#juminChk').addClass('error');
				return false;
			}
			if(jumin1 == ''){
				$('#juminChk').text('생년월일을 입력해주세요.');
				$('#juminChk').addClass('error');
				return false;
			}
			
			if(jumin2 == ''){
				$('#juminChk').text('주민번호를 입력해주세요.');
				$('#juminChk').addClass('error');
				return false;
			}
			var reqExp = /^[0-9]*$/;
			if(!reqExp.test(jumin1) || !reqExp.test(jumin2) || !reqExp.test(issuDate)){
				$('#juminChk').text('주민번호, 발급일자는 숫자를 입력해주세요.');
				$('#juminChk').addClass('error');
				return false;
			}
			
			var reqExp2 = /^[0-9]{8}$/;
			if(!reqExp2.test(issuDate)){
				$('#juminChk').text('발급일자는 8자리숫자입니다.');
				$('#juminChk').addClass('error');
				return false;
			}
			
			var reqExp3 = /^[0-9]{6}$/;
			if(!reqExp3.test(jumin1)){
				$('#juminChk').text('생년월일은 6자리숫자입니다.');
				$('#juminChk').addClass('error');
				return false;
			}
			var reqExp4 = /^[0-9]{7}$/;
			if(!reqExp4.test(jumin2)){
				$('#juminChk').text('뒷자리는 7자리숫자입니다.');
				$('#juminChk').addClass('error');
				return false;
			}
			
			var juChk = $('#JUMIN2');
			$.ajax({
				type : "get",
				url : "/signUp/checkRnn/"+juChk.val(),
				success : function(dt) {
					if (dt == '중복') {
						$('#juminChk').text('주민번호가 이미존재합니다.')
						$('#juminChk').addClass('error')
						return false;
					}else{
						$('#juminChk').text('')
						$('#juminChk').removeClass('error')
						$('#rnnChkBtn').css('display', 'none');
						$('#loadChk').css('display', 'block');
			
			
			
	//		실명인증api(횟수제한,실검증시 주석해제)
			$.ajax({
					url : "/api/idCardCheck",
					type : "POST",
					contentType : "application/json;charset=UTF-8",
					data : JSON.stringify({
							NAME : userName,
							JUMIN : rnn,
							ISSUEDATE : issuDate
					}),
					success : function(re){
						console.log(re);
						if(re.data.AGREEMENTYNE == "Y"){
							$('input[name=checked_jumin]').val("y");
							$('#rnnChkBtn').css('display', 'block');
							$('#rnnChkBtn').attr('disabled', 'true');
							$('#loadChk').css('display', 'none');
							Swal.fire({
								text: '실명인증 완료',
								icon: 'success'
							})
						}else {
							Swal.fire({
								text: '입력오류',
								icon: 'error'
							})
							$('#rnnChkBtn').css('display', 'block');
							$('#loadChk').css('display', 'none');
						}
					},
					error : function(er){
						Swal.fire({
							text: 'error',
							icon: 'error'
						})
						$('#rnnChkBtn').css('display', 'none');
						$('#loadChk').css('display', 'block');
					}
				})
					}
				}
			})
			
		}
	
	//자격증 진위여부 
	$('#check-license-Btn').click(() => {checkLic()});
	function checkLic() {
		console.log('gd');
		var lName = $('#lName').val();
		var lNo = $('#lNo').val();
		var getDt = $('#getDt').val();
		var ChkCenter = $('#lChkCenter').val();
		var uploadFile = $('#uploadFile').val();
		
		if(lName == ''){
			$('#licenseChk').text('자격증이름을 입력해주세요.');
			$('#licenseChk').addClass('error');
			return false;
		}
		if(lNo == ''){
			$('#licenseChk').text('자격증번호를 입력해주세요.');
			$('#licenseChk').addClass('error');
			return false;
		}
		if(getDt == ''){
			$('#licenseChk').text('취득일자를 입력해주세요.');
			$('#licenseChk').addClass('error');
			return false;
		}
		
		if(ChkCenter == ''){
			$('#licenseChk').text('발급기관을 입력해주세요.');
			$('#licenseChk').addClass('error');
			return false;
		}
		
		$('#check-license-Btn').css('display', 'none');
		$('#licChk').css('display', 'block');
		
		setTimeout(function(){
			$('input[name=checked_license]').val("y");
				$('#check-license-Btn').css('display', 'block');
				$('#check-license-Btn').attr('disabled', 'true');
				$('#licChk').css('display', 'none');
				Swal.fire({
					text: '자격증검증 완료',
					icon: 'success'
				})
		}, 2000);
		
// 		$.ajax({
// 		    url: "/api/techCheck/" + lNo,
// 		    type: "GET",
// 		    success: function (response) {
// 		    	console.log(response);
// 		    	if(response.body.items.result == true){
// 		    		$('input[name=checked_license]').val("y");
// 					$('#check-license-Btn').css('display', 'block');
// 					$('#check-license-Btn').attr('disabled', 'true');
// 					$('#licChk').css('display', 'none');
// 					Swal.fire({
// 						text: '자격증검증 완료',
// 						icon: 'success'
// 					})
// 		    	} else {
// 		    		Swal.fire({
// 						text: '입력오류',
// 						icon: 'error'
// 					})
// 					$('#check-license-Btn').css('display', 'block');
// 					$('#licChk').css('display', 'none');
// 		    	}
// 		    },
// 		    error: function (error) {
// 		      console.log(error)
// 		    },
// 		  });
		
		
	}
	
	//전화번호
	var phone = $('#usersPhone');
	checkPhone();
	
	function checkPhone() {
		phone.on("change", function(){
			var reqExp = /^[0-9]*$/;
			
			if(!reqExp.test(phone.val())){
				phone.next().text('숫자를 입력해주세요')
				phone.next().addClass('error')
				return ;
			}else{
				phone.next().text('')
				phone.next().removeClass('error')
			} 
						
		})
		
	} 
	
	//닉네임 중복체크
	var nick = $('#usersNick');
	checkNick();
	
	function checkNick() {
		nick.on("change", function() { 
			var reqExp = /^[ㄱ-ㅎ가-힣A-Za-z0-9-_]{2,10}$/;
		
			if(!reqExp.test(nick.val())){
				nick.next().text('닉네임은 특수문자를 제외한 2~10자리여야 합니다.')
				nick.next().addClass('error')
				return ;		
			}
			
			$.ajax({
				type : "get",
				url : "/signUp/checkNick/"+nick.val(),
				success : function(dt) {
					if (dt == '중복') {
						nick.next().text('이미 사용중인 닉네임입니다.')
						nick.next().addClass('error')
					} else {
						nick.next().text('사용가능한 닉네임입니다.')
						nick.next().removeClass('error')
						nick.next().next().css('display', 'none')
					}
				}
			})
			
		})
	}
		
	//이메일 중복체크
	var email = $('#usersEmail');
	checkEmail();
	
	function checkEmail() {
		email.on("change", function() { 
			var reqExp = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/;
	
			if (!reqExp.test(email.val())) {
				email.next().text('이메일 형식이 올바르지 않습니다.')
				email.next().addClass('error')
				return ;
			}
			
			$.ajax({
				type : "get",
				url : "/signUp/checkEmail?email="+email.val(),
				success : function(dt) {
					if (dt == '중복') { 
						email.next().text('이미 사용중인 이메일입니다.')
						email.next().addClass('error')
					} else {
						email.next().text('사용가능한 이메일입니다.')
						email.next().removeClass('error')
						email.next().next().css('display', 'none')
					}
				}
			})
		})
	}
	//아이디 중복체크(버튼)
	$('#checkBtn').click(()=>{checkId()});
	function checkId() {
		var id = $('#usersId');
		var erMsg = $('#erMsg');
		
		var reqExp = /^([A-za-z]{0,0})(?=.*[a-zA-Z])(?=.*[0-9]).{4,20}$/;
		
		if(id.val() == ''){
			//id.next().text('아이디는 필수 입력 값입니다.')
			//id.next().addClass('error')
			erMsg.text('아이디는 필수 입력 값입니다.')
			erMsg.addClass('error')
			return ; 
		} else if(!reqExp.test(id.val())){
			//id.next().text('아이디는 영어,숫자가 포함된 4~20자리여야 합니다.')
			//id.next().addClass('error')
			erMsg.text('아이디는 영어,숫자가 포함된 4~20자리여야 합니다.')
			erMsg.addClass('error')
			return ;
		}
		$.ajax({
			type : "get",
			url : "/signUp/checkId/"+id.val(),
			success : function(dt) {
				if (dt == '중복') {
					//id.next().text('이미 사용중인 아이디입니다.')
					//id.next().addClass('error')
					erMsg.text('이미 사용중인 아이디입니다.')
					erMsg.addClass('error')
				} else {
					//id.next().text('사용가능한 아이디입니다.')
					//id.next().removeClass('error')
					erMsg.text('사용가능한 아이디입니다.')
					erMsg.removeClass('error')
					$('input[name=checked_id]').val("y");
				}
			}
		})
	}

		//파일첨부 테스트
		$('#testBtn').click(()=> {getFileInfo()});
		function getFileInfo(){
	 		let formData= $('form[name="joinEzt"]').serializeArray();
	 		console.log('1) serializeArray', formData);
	 		
	 		let objData = {};
	 		$.each(formData, (idx, input) => {
	 			console.log('2) input', idx, input);
	 			objData[input.name] = input.value;	 			
	 		});
	 		
	 		console.log('3) objData', objData);
	 		return objData;
	 	}
		
	//가입하기 버튼
	$('#joinBtn').click(() => {inputChk()});
	function inputChk(){
		if($('input[name=checked_id]').val() == ''){
			Swal.fire({
			 text:'아이디 중복확인이 완료되지않았습니다.',
			 icon: 'warning'
			})
			return false;
		//실명인증 제한(나중에 주석풀기)
		if($('input[name=checked_jumin]').val() == ''){
			Swal.fire({
				 text:'실명인증이 완료되지않았습니다.',
				 icon: 'warning'
				})
				return false;
		}
		//자격증인증 제한(나중에 주석풀기)
		if($('input[name=checked_license]').val() == ''){
			Swal.fire({
				 text:'자격증인증이 완료되지않았습니다.',
				 icon: 'warning'
				})
				return false;
		}
		
		}
		if($('#JUMIN2').val()[0] == 1 || $('#JUMIN2').val()[0] == 3){
			$('#usersGender').attr('value', '남');
		}else{
			$('#usersGender').attr('value', '여');
		}
			$(joinEzt).submit();
	}
</script>
</html>