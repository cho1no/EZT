<!doctype html>
<html xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<title>회원가입</title>
<meta charset="utf-8">
<style>
form span.error {
	color: red;
	font-size: 10pt;
}

form span {
	color: blue;
	font-size: 10pt;
}
.site-section {
    padding-top: 3rem;
}
</style>
</head>
<body id="top">
		<section class="site-section">
			<div class="container">
				<div class="row">
					<div class="col-lg-6 mb-5" style="margin: auto">
						<h2 class="mb-4">사용자 회원가입</h2>
						<!-- 회원가입 폼 -->
						<form th:action="@{/signUp/joinUser}" th:object="${userVO}" method="post"
							class="p-4 border rounded" name="joinEzt">
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<label class="text-black" for="usersId">아이디</label> 
									<div class="row">
										<div class="col-8">
										<input name="usersId" type="text" id="usersId" th:field="*{usersId}"
											class="form-control" placeholder="아이디를 입력해주세요">
										</div>
										<div class="col-4">
										<button type="button" id="checkBtn"
										class="btn btn-primary float-end text-white px-4">중복확인</button>
										<input type="hidden" name="checked_id" value="">
										</div>
									</div>
									<span id="erMsg"></span>
								</div>

								<span th:errors="*{usersId}" class="error"></span>
							</div>
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<label class="text-black" for="usersPw">비밀번호</label> <input
										name="usersPw" type="password" id="usersPw"
										th:field="*{usersPw}" class="form-control"
										placeholder="비밀번호를 입력해주세요"> <span class="error"
										th:errors="*{usersPw}"></span>
								</div>
							</div>
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<label class="text-black" for="usersPw">비밀번호확인</label> <input
										name="usersPwCheck" type="password" id="usersPwCheck"
										th:field="*{usersPwCheck}" class="form-control"
										placeholder="비밀번호 확인"> <span class="error"
										th:errors="*{usersPwCheck}"></span>
								</div>
							</div>
							<div class="row form-group">
								<div class="col-md-6 mb-3 mb-md-0">
									<label class="text-black" for="usersName">성명</label>
									 <input name="usersName" type="text" id="usersName"
										th:field="*{usersName}" class="form-control" placeholder="홍길동">
									<span th:errors="*{usersName}" class="error"></span>
								</div>
								<div class="col-md-6 mb-3 mb-md-0" >
									<label class="text-block" for="issuDate">주민등록증 발급일자</label>
									<input type="text" id="issuDate" name="issuDate" class="form-control" placeholder="19001108" maxlength="8">
								</div>
							</div>
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<div>
									<label class="text-black" for="usersRnn">주민등록번호</label>
									</div> 
										<input type="text" id="JUMIN1" maxlength="6" class="form-control col-md-4 d-inline-flex"
											name="usersBirth" placeholder="880101">
									<label class="d-inline-flex">-</label>
									<input  type="password" id="JUMIN2" maxlength="7" class="form-control col-md-4 d-inline-flex"
										name="usersRnn" placeholder="1234567">
									<input type="button" style="float: right; " id="rnnChkBtn" value="실명인증" 
										class="btn px-4 btn-primary text-white"> <!-- disabled -->
										
										<input type="hidden" name="checked_jumin" value="">
										<button class="btn btn-primary" id="loadChk" style="float: right; display:none;" type="button" disabled>
										  <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
										  <span role="status">검증 중...</span>
										</button>
								</div>
										<span id=juminChk></span>
							</div>
							<div>
								<input type="text" name="usersGender" id="usersGender" style="display:none;"> 
							</div>
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<label class="text-black" for="usersPhone">전화번호</label> <input
										name="usersPhone" type="text" id="usersPhone"
										th:field="*{usersPhone}" class="form-control"
										placeholder="-제외 숫자만 입력해주세요" maxlength="11"><span></span> <span
										th:errors="*{usersPhone}" class="error"></span>
								</div>
							</div>
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<label class="text-black" for="usersNick">닉네임</label> <input
										name="usersNick" type="text" id="usersNick"
										th:field="*{usersNick}" class="form-control"
										placeholder="닉네임을 입력해주세요"> <span></span> <span
										th:errors="*{usersNick}" class="error"></span>
								</div>
							</div>
							<div class="row form-group">
								<div class="col-md-12 mb-3 mb-md-0">
									<label class="text-black" for="usersEmail">이메일</label> <input
										name="usersEmail" type="text" id="usersEmail"
										th:field="*{usersEmail}" class="form-control"
										placeholder="example@google.com"><span></span> <span
										th:errors="*{usersEmail}" class="error"></span>
								</div>
							</div>
							<div class="row form-group">
								<div class="col-md-12">
									<a href="/signUp/joinWorker">작업자로 회원가입</a>
									<input type="button" id="joinBtn" value="가입하기"
										class="btn px-4 btn-primary text-white" style="float: right">
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</section>
</body>
<script th:inline="javascript">
	$('.page-title').text('회원가입');
	$('.page-desc').text('사용자');
	
	/*
	checkJumin();
	
	function checkJumin(){
		$('#JUMIN2').on("change", function(){
			
		})
	}*/
	
	
	//주민등록증 진위여부
	$('#rnnChkBtn').click(() => {checkRnn()});
	function checkRnn(){
		var userName = $('#usersName').val();
		var jumin1 = $('#JUMIN1').val();
		var jumin2 = $('#JUMIN2').val();
		var rnn = jumin1 + jumin2; 
		var issuDate = $('#issuDate').val();
		//console.log(userName, rnn, issuDate);
		if(userName == ''){
			$('#juminChk').text('성명을 입력해주세요.');
			$('#juminChk').addClass('error');
			return false;
		}
		var reqExpUsrNm = /^[가-힣]*$/;
		if(!reqExpUsrNm.test(userName)){
			$('#juminChk').text('성명은 한글로 올바르게 입력해주세요.');
			$('#juminChk').addClass('error');
			return false;
		}
		if(issuDate == ''){
			$('#juminChk').text('주민등록증 발급일자를 입력해주세요.');
			$('#juminChk').addClass('error');
			return false;
		}
		if(jumin1 == ''){
			$('#juminChk').text('생년월일을 입력해주세요.');
			$('#juminChk').addClass('error');
			return false;
		}
		
		if(jumin2 == ''){
			$('#juminChk').text('주민번호를 입력해주세요.');
			$('#juminChk').addClass('error');
			return false;
		}
		var reqExp = /^[0-9]*$/;
		if(!reqExp.test(jumin1) || !reqExp.test(jumin2) || !reqExp.test(issuDate)){
			$('#juminChk').text('주민번호, 발급일자는 숫자를 입력해주세요.');
			$('#juminChk').addClass('error');
			return false;
		}
		
		var reqExp2 = /^[0-9]{8}$/;
		if(!reqExp2.test(issuDate)){
			$('#juminChk').text('발급일자는 8자리숫자입니다.');
			$('#juminChk').addClass('error');
			return false;
		}
		
		var reqExp3 = /^[0-9]{6}$/;
		if(!reqExp3.test(jumin1)){
			$('#juminChk').text('생년월일은 6자리숫자입니다.');
			$('#juminChk').addClass('error');
			return false;
		}
		var reqExp4 = /^[0-9]{7}$/;
		if(!reqExp4.test(jumin2)){
			$('#juminChk').text('뒷자리는 7자리숫자입니다.');
			$('#juminChk').addClass('error');
			return false;
		}
		
		var juChk = $('#JUMIN2');
		$.ajax({
			type : "get",
			url : "/signUp/checkRnn/"+juChk.val(),
			success : function(dt) {
				if (dt == '중복') {
					$('#juminChk').text('주민번호가 이미존재합니다.')
					$('#juminChk').addClass('error')
					return false;
				}else{
					$('#juminChk').text('')
					$('#juminChk').removeClass('error')
					$('#rnnChkBtn').css('display', 'none');
					$('#loadChk').css('display', 'block');
		
		
		
//		실명인증api(횟수제한,실검증시 주석해제)
		$.ajax({
				url : "/api/idCardCheck",
				type : "POST",
				contentType : "application/json;charset=UTF-8",
				data : JSON.stringify({
						NAME : userName,
						JUMIN : rnn,
						ISSUEDATE : issuDate
				}),
				success : function(re){
					console.log(re);
					if(re.data.AGREEMENTYNE == "Y"){
						$('input[name=checked_jumin]').val("y");
						$('#rnnChkBtn').css('display', 'block');
						$('#rnnChkBtn').attr('disabled', 'true');
						$('#loadChk').css('display', 'none');
						Swal.fire({
							text: '실명인증 완료',
							icon: 'success'
						})
					}else {
						Swal.fire({
							text: '입력오류',
							icon: 'error'
						})
						$('#rnnChkBtn').css('display', 'block');
						$('#loadChk').css('display', 'none');
					}
				},
				error : function(er){
					Swal.fire({
						text: 'error',
						icon: 'error'
					})
					$('#rnnChkBtn').css('display', 'none');
					$('#loadChk').css('display', 'block');
				}
			})
				}
			}
		})
		
	}
	
	//전화번호
	var phone = $('#usersPhone');
	checkPhone();
	
	function checkPhone() {
		phone.on("change", function(){
			var reqExp = /^[0-9]*$/;
			
			if(!reqExp.test(phone.val())){
				phone.next().text('숫자를 입력해주세요')
				phone.next().addClass('error')
				return ;
			}else{
				phone.next().text('')
				phone.next().removeClass('error')
			} 
						
		})
		
	} 
	
		
	//닉네임 중복체크
	var nick = $('#usersNick');
	checkNick();
	
	function checkNick() {
		nick.on("change", function() { 
			var reqExp = /^[ㄱ-ㅎ가-힣A-Za-z0-9-_]{2,10}$/;
		
			if(!reqExp.test(nick.val())){
				nick.next().text('닉네임은 특수문자를 제외한 2~10자리여야 합니다.')
				nick.next().addClass('error')
				return ;		
			}
			
			$.ajax({
				type : "get",
				url : "/signUp/checkNick/"+nick.val(),
				success : function(dt) {
					if (dt == '중복') {
						nick.next().text('이미 사용중인 닉네임입니다.')
						nick.next().addClass('error')
					} else {
						nick.next().text('사용가능한 닉네임입니다.')
						nick.next().removeClass('error')
					}
				}
			})
			
		})
	}
	
	//이메일 중복체크
	var email = $('#usersEmail');
	checkEmail();
	
	function checkEmail() {
		email.on("change", function() { 
			var reqExp = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/;
	
			if (!reqExp.test(email.val())) {
				email.next().text('이메일 형식이 올바르지 않습니다.')
				email.next().addClass('error')
				return ;
			}
			
			$.ajax({
				type : "get",
				url : "/signUp/checkEmail?email="+email.val(),
				success : function(dt) {
					if (dt == '중복') { 
						email.next().text('이미 사용중인 이메일입니다.')
						email.next().addClass('error')
					} else {
						email.next().text('사용가능한 이메일입니다.')
						email.next().removeClass('error')
					}
				}
			})
		})
	}
	//아이디 중복체크(버튼)
	$('#checkBtn').click(()=>{checkId()});
	function checkId() {
		var id = $('#usersId');
		var erMsg = $('#erMsg');
		
		var reqExp = /^([A-za-z]{0,0})(?=.*[a-zA-Z])(?=.*[0-9]).{4,20}$/;
		
		if(id.val() == ''){
			//id.next().text('아이디는 필수 입력 값입니다.')
			//id.next().addClass('error')
			erMsg.text('아이디는 필수 입력 값입니다.')
			erMsg.addClass('error')
			return ; 
		} else if(!reqExp.test(id.val())){
			//id.next().text('아이디는 영어,숫자가 포함된 4~20자리여야 합니다.')
			//id.next().addClass('error')
			erMsg.text('아이디는 영어,숫자가 포함된 4~20자리여야 합니다.')
			erMsg.addClass('error')
			return ;
		}
		$.ajax({
			type : "get",
			url : "/signUp/checkId/"+id.val(),
			success : function(dt) {
				if (dt == '중복') {
					//id.next().text('이미 사용중인 아이디입니다.')
					//id.next().addClass('error')
					erMsg.text('이미 사용중인 아이디입니다.')
					erMsg.addClass('error')
				} else {
					//id.next().text('사용가능한 아이디입니다.')
					//id.next().removeClass('error')
					erMsg.text('사용가능한 아이디입니다.')
					erMsg.removeClass('error')
					$('input[name=checked_id]').val("y");
				}
			}
		})
	}
	
	//가입하기 버튼
	$('#joinBtn').click(() => {inputChk()});
	function inputChk(){
		if($('input[name=checked_id]').val() == ''){
			Swal.fire({
			 text:'아이디 중복확인이 완료되지않았습니다.',
			 icon: 'warning'
			})
			return false;
		}
		//실명인증 제한(나중에 주석풀기)
		if($('input[name=checked_jumin]').val() == ''){
			Swal.fire({
				 text:'실명인증이 완료되지않았습니다.',
				 icon: 'warning'
				})
				return false;
		}
		
		if($('#JUMIN2').val()[0] == 1 || $('#JUMIN2').val()[0] == 3){
			$('#usersGender').val('남');
		}else{
			$('#usersGender').val('여');
		}
			$(joinEzt).submit();
	}
</script>
</html>